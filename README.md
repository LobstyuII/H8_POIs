
# Experimental Codebase for "Research Proposal: Quantifying the Urban Greenery Underestimation Due to Foliar Dust Retention"

Welcome to the experimental codebase. This repository is primarily designed for personal research purposes, ensuring that each code module is independent and adjustable. Currently, the code is organized in a distributed manner without a centralized `main.py` to orchestrate all components, and some experiments lack unified custom function calls. Before the associated research paper is published, we plan to refactor the code for improved efficiency and enhanced global coordination.

## Prerequisites

- **Conda**
- **Python 3.x**
- **NASA Earthdata Token**
- **JAXA FTP Account**
        
## Installation

### 1. Clone the Repository

```bash
git clone https://github.com/LobstyuII/H8_POIs.git
cd H8_POIs
```

### 2. Create and Activate Conda Environment

Create the Conda environment with the required dependencies:

```bash
conda create -n H8_POIs_env -c conda-forge tqdm netCDF4 matplotlib requests py6s pandas gdal numpy pytorch scikit-learn seaborn geopandas tenacity scipy statsmodels celery redis-py eventlet 
conda activate H8_POI_env 
pip install earthengine-api
```

## Configuration

### 1. Set Up Earthdata Token

Ensure that the `my_NASA_API_token` file is placed in the root directory of this project. This file must contain your personal Earthdata token, which is required to access NASA's API.

**To obtain your personal token:**

1. Log in to your Earthdata account at: [Earthdata Login](https://urs.earthdata.nasa.gov/profile)
    
2. Navigate to the **Application - Authorized Apps** tab and ensure the following applications are authorized:
    
    - NASA GESDISC DATA ARCHIVE
    - LP DAAC Data Pool
3. Go to the **Generate Token** tab to create your personal token.
    
4. Once you have your token, save it to the appropriate location using the following command:
    
 ```bash   
echo "your_copied_token_here" > ~/your_repository/my_NASA_API_token   
```
### 2. Update JAXA FTP Connection Information

Replace the following lines in your configuration with your own FTP credentials:

```bash
FTP_ADDRESS = "ftp.ptree.jaxa.jp" 
FTP_UID = "YourFTPUsername"
FTP_PW = "YourFTPPassword"`
```
## Usage

Open a new terminal, activate the Conda environment, navigate to the repository, check the list and run a code:

```bash
conda activate H8_POIs_env
cd H8_POIs
python down_process_delete_H8L1.py
```

This will execute the necessary scripts for data processing and analysis.
## Features Overview

### 1. Data Download

#### 1.1 Himawari-8 Data Download and Processing

- **Script**: `down_process_delete_H8L1.py`
- **Description**: Downloads Himawari-8 10-minute band reflectance data from the JAXA FTP server. Due to the original data size exceeding 30TB, a segmented streaming approach of download-process-delete is employed to ensure that gridded data is promptly converted to POIs data. Original files are deleted post-processing to free up server storage.
- **Note**: Replace the JAXA FTP download account credentials (lines 17-19) in the script with your own. According to JAXA regulations, the number of download channels is limited to 28, with a reset every 6 hours. The script includes checkpoint and resume functionality; if failures occur, please rerun the script. Additionally, you can reduce the `max_workers` parameter from 28 to 16 or lower to minimize the risk of channel congestion.

#### 1.2 Himawari-8 L2ARP Data Download and Processing

- **Script**: `down_process_delete_H8L2ARP.py`
- **Description**: Downloads and processes Himawari-8 L2ARP data. Similar to section 1.1, but L2ARP original files are smaller (1-5MB), making channel congestion more likely.
- **Note**: Refer to the notes in section 1.1.

#### 1.3 MCD12Q1 Data Processing

- **Script**: `mcd12q1_process.py`
- **Description**: Processes MCD12Q1 data using `station_xy_lookup_table.csv`, generated by `build_xy_lookuptable.py`, which contains geographic coordinates of POIs and their corresponding lookup tables for various data formats.

#### 1.4 ERA5 GEE Download

- **Script**: `era5_gee_download.py`
- **Description**: Downloads ERA5 data from Google Earth Engine (GEE).
- **Note**: Ensure that your personal GEE token file is prepared in advance.

#### 1.5 MOD08 Total Water Vapor Column/Ozone Column Data Download and Processing

- **Script**: `download_mod08_2.py`
- **Description**: Downloads and processes MOD08 data.
- **Note**:
    - Obtain the specific download URLs from the official website in `.txt` format.
    - Acquire your personal NASA token and replace it locally in the script.

### 2. Data Preprocessing

#### 2.1 Generating Daily Best Data

- **Script**: `h8dailybest.py`
- **Description**: Selects the best pixel for each POI daily by choosing data with no cloud cover and the smallest solar zenith angle (SOZ).

#### 2.2 Pixel-level 6S Atmospheric Correction

- **Script**: `poi_6s.py`
- **Description**: Performs 6S atmospheric correction on each pixel.

#### 2.3 VIs Calculation and High-Frequency Signal Extraction

- **Script**: `STL_decomposition_NDMI_SAVI_CVI_MSAVI.py`
- **Description**: Includes steps for filling invalid values, smoothing, and time series decomposition to extract high-frequency signals for each Vegetation Index (VI).

#### 2.4 Building a Rainfall Events-Based Dataset

- **Script**: `build_rainfall_events_ultimate.py`
- **Description**: Constructs a multi-factors dataset based on rainfall events.

### 3. Model Generation and Evaluation

#### 3.1 Data Import and Model Preprocessing

- **Script**: `2model_preprocess_LSTM_with_mask.py`
- **Description**: Imports data and performs model preprocessing.

#### 3.2 Model Execution and Evaluation

- **Script**: `2model_evaluate_model.py`
- **Description**: Runs the model and evaluates its performance.

#### 3.3 Model Results Visualization

- **Script**: `round2_new_visualize_results_last.py`
- **Description**: Visualizes the results of the model.

### 4. Result Visualization

#### 4.1 Residuals Plotting

- **Script**: `visualize_fE_fNE_with_prior.py`
- **Description**: Plots residuals.

#### 4.2 Model Factor Correlation Plotting

- **Script**: `round2_generate_factor_correlation_new.py`
- **Description**: Plots the correlation between model factors.

#### 4.3 Model Factor Importance Plotting

- **Script**: `round2_generate_feature_importance_captum.py`
- **Description**: Uses Integrated Gradients to plot the importance of model factors.

#### 4.4 Geographic Distribution of Model Results

- **Script**: `plot_geolocation_fE_fNE_2.py`
- **Description**: Plots the f_E and f_NE geographic distribution of model results.

## Introduction

This project is divided into several core components, each responsible for a specific part of the download and analysis process. The POI data is provided in the `H8_POIs/Air_stations_lon_lat.csv` file located in the root directory. This file contains station IDs in string format, with latitude and longitude coordinates adhering to the WGS84 reference system.

## Future Plans

Prior to the publication of related research findings, we intend to refactor the codebase to integrate all modules into a unified execution framework, optimizing the code structure to enhance overall efficiency and maintainability.

## Contact

For any questions or issues, please reach out via [2001212684@alumni.pku.edu.cn](mailto:2001212684@alumni.pku.edu.cn).
